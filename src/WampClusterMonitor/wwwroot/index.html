<!DOCTYPE html>
<html>
    <head>
        <title>Cluster monitor</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

        <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
    </head>
    <body>
        <h1>Cluster monitor</h1>
        
        <div id="container">

        </div>

        <hr />
        <div id="lblStatus">Initialising...</div>

        <script type="text/javascript">
            $(() =>
            {
                const nodePanels = {};

                // The WAMP port number is always 100 more than the web one.
                const wampPort = window.location.port + 100;

                const connection = new autobahn.Connection({
                    url: `ws://localhost:${wampPort}`,
                    realm: "ClusterMonitor"
                });
                connection.onopen = (session, details) =>
                {
                    session.subscribe("cluster-nodes", args =>
                    {
                        const message = args[0];

                        console.log(
                            `'${message.Name}' => '${message.State}'`
                        );

                        let nodePanel = nodePanels[message.Name];
                        if (!nodePanel)
                        {
                            const root = $(`
                                <div class="card w-50">
                                    <div class="card-block">
                                        <h4 class="card-title node-name">${message.Name}</h4>
                                        <h6 class="card-subtitle mb-2 text-muted node-state">${message.State}</h6>
                                    </div>
                                </div>
                            `);
                            nodePanel = {
                                root: root,
                                name: root.find("div .node-name"),
                                state: root.find("div .node-state")
                            };
                            nodePanels[message.Name] = nodePanel;

                            $("#container").append(nodePanel.root);
                        }
                        else
                            nodePanel.state.text(message.State);

                        if (message.State == "Removed")
                        {
                            nodePanel.root.remove();
                            delete nodePanels[message.Name];
                        }
                    });

                    $("#lblStatus").text("Connected.");
                };
                connection.onclose = (reason, details) =>
                {
                    $("#lblStatus").text("Disconnected.");
                };
                
                $("#lblStatus").text("Connecting...");
                connection.open();
            });
        </script>

        <script src="js/autobahn.js"></script>
        <script src="js/tether.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    </body>
</html>
